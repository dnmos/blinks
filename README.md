# Blink: Мониторинг неработающих виджетов и ссылок Tripster

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## О проекте

**Blink** - это скрипт на Python, предназначенный для автоматического мониторинга виджетов и партнерских ссылок Tripster, размещенных на сайтах WordPress. Скрипт помогает выявлять неработающие виджеты и ссылки, которые могут возникать из-за удаления экскурсий на Tripster или других изменений. При обнаружении проблем, необходимо вручную проверять результаты и принимать меры для поддержания актуальности контента на сайте.

**Основные возможности:**

*   **Автоматическое обнаружение виджетов Tripster на страницах WordPress.**
*   **Проверка статуса виджетов Tripster.**
*   **Проверка работоспособности партнерских ссылок Tripster.**
*   **Ручная проверка и принятие мер на основе результатов работы скрипта.**

## Быстрый старт

Эти шаги помогут вам быстро запустить `Blink` для мониторинга ваших виджетов и ссылок Tripster.

**Предварительные шаги:**

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/dnmos/blinks.git
    cd blinks
    ```

2.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

3.  **Настройте `.env` файл:**
    Скопируйте файл `.env_example` в `.env` и заполните необходимые переменные окружения. Необходимые переменные для запуска:

    ```env
    PROJECT_ROOT = ""       # Корневая директория проекта (абсолютный путь).  Например: /home/user/blinks.  Используется для определения абсолютных путей к файлам и директориям внутри проекта.

    BASE_URL = ""           # Доменное имя вашего сайта WordPress (например: your-site.com).  Используется для формирования URL-адресов WordPress API.  **Должен начинаться с `https://`.**

    API_PATH = "/wp-json/wp/v2/posts"  # Путь к API WordPress для получения постов.  Обычно не требует изменений.

    POSTS_PER_PAGE = 10      # Количество постов WordPress, получаемых за один запрос к API.  Влияет на количество запросов к API и скорость работы скрипта wordpress_post_indexer.py.

    TRIPSTER_DOMAIN = "tripster.ru" # Домен Tripster, используется для фильтрации и проверки ссылок, чтобы убедиться, что они ведут на сайт Tripster.

    JSON_DIR = "json"         # Директория для хранения JSON файлов с собранными данными.  Относительный путь от `PROJECT_ROOT`.

    POST_DATA_FILE = "post_data.json" # Имя файла для сохранения данных о постах WordPress (ID и заголовки).  Используется скриптом wordpress_post_indexer.py и tripster_link_processor.py.

    TRIPSTER_LINKS_FILE = "tripster_links.json" # Имя файла для сохранения списка ссылок Tripster (виджеты и партнерские ссылки). Используется скриптом tripster_link_processor.py.

    # DB
    DB_HOST = ""          # Хост базы данных MySQL (например: localhost).
    DB_USER = ""          # Имя пользователя базы данных MySQL.
    DB_NAME = ""          # Имя базы данных MySQL.
    DB_PASSWORD = ""      # Пароль для доступа к базе данных MySQL.
    ```
    Заполните значения напротив каждой переменной в файле `.env`. **Важно: Не удаляйте и не изменяйте названия переменных.**

**Порядок запуска скриптов:**

Для корректной работы `Blink` необходимо запустить скрипты в следующей последовательности:

1.  **`wordpress_post_indexer.py`**: Запрашивает посты из WordPress API, получает post_id и title, сохраняет их в JSON (`json/post_data.json`).
    ```bash
    python -m scripts.wordpress_post_indexer
    ```

2.  **`tripster_link_processor.py`**: Извлекает виджеты и партнерские ссылки Tripster из постов, сохраняет их в базу данных MySQL.
    ```bash
    python -m scripts.tripster_link_processor
    ```

## Структура проекта

Проект `Blink` организован в следующие директории и файлы:

```
blinks/
├── core/
│ ├── tripster_api_utils.py
│ ├── tripster_data_extractor.py
│ └── wp_api_utils.py
├── db/ # Директория для работы с БД
│ ├── db.py # Функции для работы с базой данных
│ └── sql/ # Директория для хранения SQL-запросов
│ ├── db_create_tables.sql # SQL-запрос для создания таблиц
│ ├── db_drop_tables.sql # SQL-запрос для удаления таблиц
│ └── db_insert_tripster.sql # SQL-запрос для вставки/обновления данных
├── .env
├── json/
│ └── post_data.json
├── project_structure.txt
├── README.md
├── requirements.txt
└── scripts/
├── tripster_link_processor.py
└── wordpress_post_indexer.py
```

```
tree -a -I "env|.git|.env_example|__init__.py" . > project_structure.txt
```

**Описание директорий и файлов:**

*   **`core/`**: Директория, содержащая основные, переиспользуемые модули проекта.
    *   `tripster_api_utils.py`: Модуль, содержащий утилитарные функции для работы с API Tripster.
    *   `tripster_data_extractor.py`: Модуль, предназначенный для извлечения данных, связанных с Tripster (виджеты, партнерские ссылки) из HTML-контента.
    *   `wp_api_utils.py`: Модуль, содержащий утилитарные функции для работы с WordPress API.

*   **`db/`**: Директория, содержащая файлы, связанные с работой с базой данных MySQL.
    *   `db.py`: Модуль, содержащий функции для подключения к базе данных, выполнения запросов и обработки результатов.
    *   `sql/`: Директория для хранения SQL-запросов.
        *   `db_create_tables.sql`: SQL-запрос для создания таблиц в базе данных.
        *   `db_drop_tables.sql`: SQL-запрос для удаления таблиц из базы данных.
        *   `db_insert_tripster.sql`: SQL-запрос для вставки или обновления данных о виджетах и ссылках Tripster.

*   **.env**: Файл конфигурации, содержащий переменные окружения, необходимые для работы скриптов (токены, URL сайта, параметры подключения к базе данных и т.д.). **Важно: Создайте этот файл на основе `.env_example` и заполните пустые значения. НИКОГДА не коммитьте файл `.env` в репозиторий!**

*   **`json/`**: Директория для хранения JSON-файлов.
    *   `post_data.json`: Файл, в котором хранятся данные о постах WordPress (ID, заголовки), полученные скриптом `wordpress_post_indexer.py`.
    *   `tripster_links.json`: **Больше не используется**.

*   **`project_structure.txt`**: Файл `project_structure.txt`, содержащий структуру проекта в текстовом виде.

*   **`README.md`**: Файл `README.md`, содержащий описание проекта, инструкции по установке и использованию и т.д.

*   **`requirements.txt`**: Файл, содержащий список Python-библиотек, необходимых для работы проекта.

*   **`scripts/`**: Директория, содержащая исполняемые скрипты проекта.
    *   `tripster_link_processor.py`: Скрипт для обработки партнерских ссылок Tripster, проверки их статуса (в будущих версиях) и сохранения данных в базу данных MySQL.
    *   `wordpress_post_indexer.py`: Скрипт для индексации постов WordPress, извлечения ID и заголовков постов.

**Ключевые классы и функции:**

*   **`core/wp_api_utils.py`**:
    *   `fetch_wordpress_posts(api_url, page=1)`: Получает список постов из WordPress API с учетом пагинации.
    *   `fetch_wordpress_post_by_id(api_url, post_id)`: Получает данные поста по его ID из API WordPress.
    *   `construct_json_file_path(filename)`: Строит полный путь к JSON-файлу, учитывая директорию JSON_DIR.
    *   `save_data_to_json_file(data, filename=None)`: Сохраняет данные в JSON-файл.
*   **`core/tripster_api_utils.py`**:
    *   `check_deeplink_status_api(deeplink_id)`: Проверяет статус диплинка через API Tripster.
*   **`core/tripster_data_extractor.py`**:
    *   `extract_tripster_widgets(html_content, tripster_domain="tripster.ru", max_retries=3, retry_delay=2)`: Извлекает виджеты Tripster из HTML-контента.
    *   `extract_deeplinks(html_content, tripster_domain="tripster.ru")`: Извлекает диплинки Tripster из HTML-контента, исключая ссылки внутри виджетов.
*   **`db/db.py`**:
    *   `connect()`: Устанавливает соединение с базой данных MySQL.
    *   `parse_sql(filename)`: Читает SQL-запросы из файла.
    *   `insert(query, values)`: Выполняет SQL-запрос для вставки данных в базу данных.

## Поток данных и логика

1.  Скрипт `wordpress_post_indexer.py` получает список постов из WordPress API, используя `core/wp_api_utils.py`.
2.  Данные (ID и заголовки постов) сохраняются в `json/post_data.json` с использованием `core/wp_api_utils.py`.
3.  Скрипт `tripster_link_processor.py` читает данные из `json/post_data.json`, используя `core/wp_api_utils.py`.
4.  Для каждого поста извлекается HTML-контент, используя `core/wp_api_utils.py`.
5.  Из HTML-контента извлекаются виджеты и диплинки Tripster, используя `core/tripster_data_extractor.py`.
6.  Для диплинков проверяется статус через API Tripster, используя `core/tripster_api_utils.py`.
7.  Данные о виджетах и диплинках сохраняются в базу данных MySQL, используя функции из `db/db.py`.
8.  Далее, пользователь должен вручную проверить данные в базе данных на предмет неработоспособных виджетов и диплинков и принять соответствующие меры.

## Используемые библиотеки и фреймворки

*   `requests`: Используется для отправки HTTP-запросов к API WordPress и API Tripster.
*   `python-dotenv`: Используется для загрузки переменных окружения из файла `.env`.
*   `beautifulsoup4`: Используется для парсинга HTML-контента страниц WordPress.
*   `urllib.parse`: Используется для работы с URL.
*   `tenacity`: Используется для реализации повторных попыток при запросах к API.
*   `pymysql`: Используется для взаимодействия с базой данных MySQL.

## Запуск скриптов

В разделе "Быстрый старт" описан основной порядок запуска скриптов. Вот более подробное описание каждого скрипта и процесса их работы.

1.  **`wordpress_post_indexer.py`**:

    *   **Назначение:** Скрипт является первым шагом в процессе мониторинга. Он подключается к WordPress API вашего сайта, собирает список всех постов и извлекает из них необходимую информацию: ID постов, заголовки. Главная цель - подготовить данные для дальнейшей обработки и поиска виджетов и ссылок Tripster.
    *   **Действия:**
        *   Читает переменные окружения из файла `.env`, включая `BASE_URL`, `API_PATH`, `POSTS_PER_PAGE`.
        *   Запрашивает WordPress API (`/wp-json/wp/v2/posts`) постранично, получая список постов.
        *   Для каждого поста извлекает ID и заголовок.
        *   **Использует функцию `unescape_html` для декодирования HTML-сущностей в заголовках постов, чтобы правильно отображать специальные символы (например, кавычки, амперсанды). В случае ошибки при декодировании, возвращается исходный, необработанный текст.**
        *   Сохраняет полученные данные (ID и заголовки постов) в JSON файл `json/post_data.json`. Файл перезаписывается при каждом запуске скрипта.
    *   **Запуск:**
        ```bash
        python -m scripts.wordpress_post_indexer
        ```
    *   **Результат:** Создается или обновляется файл `json/post_data.json`, содержащий список постов WordPress с их ID и заголовками. Этот файл используется скриптом `tripster_link_processor.py` на следующем шаге.

2.  **`tripster_link_processor.py`**:

    *   **Назначение:** Скрипт является вторым и **последним** шагом. Он обрабатывает данные о постах WordPress, собранные на первом шаге, и **извлекает из контента каждого поста виджеты и партнерские ссылки Tripster**. Затем он проверяет работоспособность партнерских ссылок (для диплинков) и виджетов (через API) и сохраняет результаты.
    *   **Действия:**
        *   Читает переменные окружения из файла `.env`, включая `TRIPSTER_DOMAIN`, `MAX_RETRIES`, `RETRY_DELAY`, `DB_HOST`, `DB_USER`, `DB_NAME`, `DB_PASSWORD`, `DB_INSERT_TRIPSTER_QUERY_PATH`.
        *   Читает данные о постах из JSON файла `json/post_data.json`, созданного скриптом `wordpress_post_indexer.py`.
        *   Для каждого поста:
            *   Запрашивает полную версию поста через WordPress API, получая HTML-контент. **Использует повторные попытки с экспоненциальной задержкой в случае ошибки при получении данных из WordPress API.**
            *   **Используя модуль `tripster_data_extractor.py`, извлекает из HTML-контента виджеты и партнерские ссылки Tripster. Для проверки статуса диплинков и виджетов используется функция `check_deeplink_status_api` из модуля `core/tripster_api_utils.py`.**
            *   Данные о виджетах и ссылках сохраняются в базу данных MySQL, используя функции из `db/db.py`.
    *   **Запуск:**
        ```bash
        python -m scripts.tripster_link_processor
        ```
    *   **Результат:** Данные о виджетах и ссылках Tripster сохраняются в таблице `wptq_tripster_links` базы данных MySQL. **После выполнения скрипта необходимо вручную проанализировать данные в базе данных и проверить виджеты и ссылки на предмет неработоспособности. В случае обнаружения неработоспособных элементов, необходимо принять соответствующие меры (например, удалить их из поста или обновить ссылки).**

## Важные замечания по текущей версии скриптов:

*   Скрипт `tripster_link_processor.py` использует функцию `check_deeplink_status_api` из модуля `core/tripster_api_utils.py` для проверки статуса **диплинков и виджетов** Tripster через API.
*   Данные о виджетах и ссылках сохраняются в базе данных MySQL, используя функции из `db/db.py`.
*   **После выполнения скрипта `tripster_link_processor.py` необходимо вручную проанализировать данные в базе данных и проверить виджеты и ссылки на предмет неработоспособности. В случае обнаружения неработоспособных элементов, необходимо принять соответствующие меры (например, удалить их из поста или обновить ссылки).**

## Вклад в проект

Мы приветствуем вклад в развитие проекта `Blink`! Чтобы ваш вклад был максимально эффективным и соответствовал целям проекта, пожалуйста, ознакомьтесь со следующими рекомендациями.

### Входные данные и ожидаемые результаты

Каждый скрипт в проекте имеет определенные входные данные и создает определенные выходные данные.

*   **`wordpress_post_indexer.py`**:
    *   Входные данные:
        *   Переменные окружения: `BASE_URL`, `API_PATH`, `POSTS_PER_PAGE` (определены в файле `.env`).
        *   WordPress API доступный по адресу, сформированному из `BASE_URL` и `API_PATH`.
    *   Выходные данные:
        *   JSON файл `json/post_data.json`, содержащий список постов WordPress (ID и заголовки).
        *   Лог-сообщения в консоль и в файл (если настроено).
    *   Ожидаемый формат выходных данных:
        ```json
        [
            {
                "order": 1,
                "id": 123,
                "title": "Заголовок поста"
            },
            ...
        ]
        ```

*   **`tripster_link_processor.py`**:
    *   Входные данные:
        *   Переменные окружения: `TRIPSTER_DOMAIN`, `MAX_RETRIES`, `RETRY_DELAY`, `DB_HOST`, `DB_USER`, `DB_NAME`, `DB_PASSWORD`, `DB_INSERT_TRIPSTER_QUERY_PATH` (определены в файле `.env`).
        *   JSON файл `json/post_data.json`, созданный скриптом `wordpress_post_indexer.py`.
        *   HTML-контент постов WordPress, полученный через WordPress API.
    *   Выходные данные:
        *   Данные о виджетах и ссылках Tripster, сохраненные в таблице `wptq_tripster_links` базы данных MySQL.
        *   Лог-сообщения в консоль и в файл (если настроено).
    *   Ожидаемый формат выходных данных:
        ```sql
        Таблица `wptq_tripster_links` содержит следующие поля:
            id INT AUTO_INCREMENT PRIMARY KEY,
            post_id INT NOT NULL,
            post_title VARCHAR(255) NOT NULL,
            link_type ENUM('widget', 'deeplink') NOT NULL,
            widget_id VARCHAR(255),
            widget_title VARCHAR(255),
            deeplink_url VARCHAR(255),
            status VARCHAR(50),
            inactivity_reason VARCHAR(255),
            is_unknown_type BOOLEAN,
            timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
        ```

### Стандарты кодирования

Для поддержания высокого качества кода и упрощения совместной работы, мы придерживаемся следующих стандартов кодирования:

*   **Соответствие PEP 8:** Код должен соответствовать стандарту PEP 8 для оформления кода на Python.
*   **Читаемость кода:** Код должен быть написан таким образом, чтобы его было легко читать и понимать. Используйте понятные имена переменных и функций, избегайте сложного и запутанного кода.
*   **Документирование кода:** Код должен быть хорошо документирован с использованием комментариев и docstrings. Каждый модуль, класс и функция должны иметь docstring, описывающий их назначение, аргументы и возвращаемые значения.
*   **Проверка стиля кода:** Используйте инструменты `flake8` и `pylint` для автоматической проверки соответствия кода стандартам кодирования.

### Тестирование

Перед отправкой изменений, убедитесь, что все тесты проходят успешно.

*   **Unit-тесты:** Мы используем unit-тесты для проверки корректности работы отдельных функций и классов.
*   **Запуск тестов:** Для запуска тестов используйте команду `python -m unittest discover`.
*   **Покрытие кода:** Стремитесь к тому, чтобы тесты покрывали большую часть кода.

### Потребность в документации

Мы считаем, что хорошо документированный код - это важная часть любого успешного проекта.

*   **Docstrings:** Каждый модуль, класс и функция должны иметь docstring, описывающий их назначение, аргументы и возвращаемые значения.
*   **Комментарии:** Используйте комментарии для объяснения сложных участков кода и для предоставления дополнительной информации.

### Поддержание структуры

Поддержание четкой и понятной структуры проекта - это важно для упрощения навигации и понимания кода.

*   **Следование структуре:** Размещайте файлы в соответствующих директориях (например, основные модули в `core`, скрипты в `scripts`).
*   **Согласованность:** Поддерживайте согласованность в именовании файлов, классов и функций.

### Фокус на читаемости кода

Читаемый код - это код, который легко понять и поддерживать.

*   **Именование:** Используйте понятные и описательные имена для переменных, функций и классов.
*   **Разбиение на функции:** Разбивайте сложные функции на более мелкие и простые.
*   **Избегайте сложных конструкций:** Старайтесь избегать слишком сложных и запутанных конструкций кода.

### Подробное описание условий

Для обеспечения правильной работы скриптов, необходимо соблюдать определенные условия.

*   **Доступ к API:** Убедитесь, что у вас есть доступ к API Tripster и WordPress и что вы соблюдаете условия использования API.
*   **Переменные окружения:** Убедитесь, что все необходимые переменные окружения определены в файле `.env` и имеют правильные значения.
*   **Зависимости:** Убедитесь, что все необходимые Python-библиотеки установлены.
*   **База данных MySQL:** Убедитесь, что у вас есть доступ к базе данных MySQL и что таблица `wptq_tripster_links` (или ее аналог) создана.

## Лицензия

Проект `Blink` распространяется под лицензией [MIT License](https://opensource.org/licenses/MIT).

## Автор

Дмитрий Лузин
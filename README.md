# Blink: Мониторинг неработающих виджетов и ссылок Tripster

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## О проекте

**Blink** - это скрипт на Python, предназначенный для автоматического мониторинга виджетов и партнерских ссылок Tripster, размещенных на сайтах WordPress. Скрипт помогает выявлять неработающие виджеты и ссылки, которые могут возникать из-за удаления экскурсий на Tripster или других изменений. При обнаружении проблем, необходимо вручную проверять результаты и принимать меры для поддержания актуальности контента на сайте.

**Основные возможности:**

*   **Автоматическое обнаружение виджетов Tripster на страницах WordPress.**
*   **Проверка статуса виджетов Tripster.**
*   **Проверка работоспособности партнерских ссылок Tripster.**
*   **Ручная проверка и принятие мер на основе результатов работы скрипта.**

## Быстрый старт

Эти шаги помогут вам быстро запустить `Blink` для мониторинга ваших виджетов и ссылок Tripster.

**Предварительные шаги:**

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/dnmos/blinks.git
    cd blinks
    ```

2.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

3.  **Настройте `.env` файл:**
    Скопируйте файл `.env_example` в `.env` и заполните необходимые переменные окружения. Необходимые переменные для запуска:

    ```env
    PROJECT_ROOT = ""       # Корневая директория проекта (абсолютный путь).  Например: /home/user/blinks.  Используется для определения абсолютных путей к файлам и директориям внутри проекта.

    BASE_URL = ""           # Доменное имя вашего сайта WordPress (например: your-site.com).  Используется для формирования URL-адресов WordPress API.  **Должен начинаться с `https://`.**

    API_PATH = "/wp-json/wp/v2/posts"  # Путь к API WordPress для получения постов.  Обычно не требует изменений.

    POSTS_PER_PAGE = 10      # Количество постов WordPress, получаемых за один запрос к API.  Влияет на количество запросов к API и скорость работы скрипта wordpress_post_indexer.py.

    TRIPSTER_DOMAIN = "tripster.ru" # Домен Tripster, используется для фильтрации и проверки ссылок, чтобы убедиться, что они ведут на сайт Tripster.

    JSON_DIR = "json"         # Директория для хранения JSON файлов с собранными данными.  Относительный путь от `PROJECT_ROOT`.

    POST_DATA_FILE = "post_data.json" # Имя файла для сохранения данных о постах WordPress (ID и заголовки).  Используется скриптом wordpress_post_indexer.py и tripster_link_processor.py.

    TRIPSTER_LINKS_FILE = "tripster_links.json" # Имя файла для сохранения списка ссылок Tripster (виджеты и партнерские ссылки). Используется скриптом tripster_link_processor.py.
    ```
    Заполните значения напротив каждой переменной в файле `.env`. **Важно: Не удаляйте и не изменяйте названия переменных.**

**Порядок запуска скриптов:**

Для корректной работы `Blink` необходимо запустить скрипты в следующей последовательности:

1.  **`wordpress_post_indexer.py`**: Запрашивает посты из WordPress API, получает post_id и title, сохраняет их в JSON (`json/post_data.json`).
    ```bash
    python -m scripts.wordpress_post_indexer
    ```

2.  **`tripster_link_processor.py`**: Извлекает виджеты и партнерские ссылки Tripster из постов, сохраняет их в JSON (`json/tripster_links.json`).
    ```bash
    python -m scripts.tripster_link_processor
    ```

## Структура проекта

Проект `Blink` организован в следующие директории и файлы:

```
blinks/
├── core/
│ ├── tripster_data_extractor.py
│ └── wp_api_utils.py
├── json/
│ ├── post_data.json
│ └── tripster_links.json
├── scripts/
│ ├── tripster_link_processor.py
│ └── wordpress_post_indexer.py
├── .env
├── project_structure.txt
├── README.md
└── requirements.txt
```


**Описание директорий и файлов:**

*   **`core/`**: Директория, содержащая основные, переиспользуемые модули проекта. Эти модули предоставляют общие функции и классы, которые используются несколькими скриптами.

    *   `tripster_data_extractor.py`: Модуль, предназначенный для извлечения данных, связанных с Tripster (виджеты, партнерские ссылки) из HTML-контента. Содержит функции для поиска и парсинга HTML, специфичного для Tripster. Используется в `tripster_link_processor.py` для извлечения виджетов и ссылок из контента постов WordPress.

    *   `wp_api_utils.py`: Модуль, содержащий утилитарные функции для работы с WordPress API. Включает функции для аутентификации, отправки запросов к API WordPress, обработки ответов и сохранения данных в JSON файлы. Используется в `wordpress_post_indexer.py` для получения списка постов и в `tripster_link_processor.py` для получения контента отдельных постов.

*   **`json/`**: Директория для хранения JSON-файлов с данными, собранными и обработанными скриптами. Эти файлы служат для обмена данными между скриптами.

    *   `post_data.json`: Файл, в котором хранятся данные о постах WordPress (ID, заголовки), полученные скриптом `wordpress_post_indexer.py`. Используется в `tripster_link_processor.py` для итерации по постам и извлечения контента.

    *   `tripster_links.json`: Файл, в котором хранится список партнерских ссылок и информация о виджетах Tripster, найденных и обработанных скриптами. Этот файл содержит результаты работы `tripster_link_processor.py`.

*   **`scripts/`**: Директория, содержащая исполняемые скрипты проекта. Каждый скрипт выполняет определенную задачу в процессе мониторинга виджетов и ссылок Tripster.

    *   `tripster_link_processor.py`: Скрипт для обработки партнерских ссылок Tripster, проверки их статуса (в будущих версиях) и обновления данных в `json/tripster_links.json`. Использует данные из `json/post_data.json` и модуль `core/tripster_data_extractor.py`. В текущей версии он в основном отвечает за извлечение виджетов и ссылок из контента постов WordPress.

    *   `wordpress_post_indexer.py`: Скрипт для индексации постов WordPress, извлечения ID и заголовков постов. Использует модуль `core/wp_api_utils.py` для взаимодействия с WordPress API и сохраняет результаты в `post_data.json`. Этот скрипт является отправной точкой процесса сбора данных.

*   **.env**: Файл конфигурации, содержащий переменные окружения, необходимые для работы скриптов (токены, URL сайта и т.д.). **Важно: Создайте этот файл на основе `.env_example` и заполните пустые значения. НИКОГДА не коммитьте файл `.env` в репозиторий!**

*   `project_structure.txt`: Файл `project_structure.txt`, содержащий структуру проекта в текстовом виде. Создан командой:

    ```bash
    tree -a -I "env|.git|.env_example|__init__.py" . > project_structure.txt
    ```

*   `requirements.txt`: Файл, содержащий список Python-библиотек, необходимых для работы проекта. Используется для установки зависимостей командой `pip install -r requirements.txt`.

**Ключевые классы и функции:**

*   **`core/wp_api_utils.py`**:
    *   `fetch_wordpress_posts(api_url, page=1)`: Получает список постов из WordPress API с учетом пагинации.
    *   `fetch_wordpress_post_by_id(api_url, post_id)`: Получает данные поста по его ID из API WordPress.
    *   `construct_json_file_path(filename)`: Строит полный путь к JSON-файлу, учитывая директорию JSON_DIR.
    *   `save_data_to_json_file(data, filename=None)`: Сохраняет данные в JSON-файл.
*   **`core/tripster_api_utils.py`**:
    *   `check_deeplink_status_api(deeplink_id)`: Проверяет статус диплинка через API Tripster.
*   **`core/tripster_data_extractor.py`**:
    *   `extract_tripster_widgets(html_content, tripster_domain="tripster.ru", TRIPSTER_WIDGET_CLASS = 'tripster-widget', max_retries=3, retry_delay=2)`: Извлекает виджеты Tripster из HTML-контента.
    *   `extract_deeplinks(html_content, tripster_domain="tripster.ru")`: Извлекает диплинки Tripster из HTML-контента, исключая ссылки внутри виджетов.

## Поток данных и логика

1.  Скрипт `wordpress_post_indexer.py` получает список постов из WordPress API, используя `core/wp_api_utils.py`.
2.  Данные (ID и заголовки постов) сохраняются в `json/post_data.json` с использованием `core/wp_api_utils.py`.
3.  Скрипт `tripster_link_processor.py` читает данные из `json/post_data.json`, используя `core/wp_api_utils.py`.
4.  Для каждого поста извлекается HTML-контент, используя `core/wp_api_utils.py`.
5.  Из HTML-контента извлекаются виджеты и диплинки Tripster, используя `core/tripster_data_extractor.py`.
6.  Для диплинков проверяется статус через API Tripster, используя `core/tripster_api_utils.py`.
7.  Данные о виджетах и диплинках сохраняются в `json/tripster_links.json` с использованием `core/wp_api_utils.py`.
8.  Далее, пользователь должен вручную проверить `json/tripster_links.json` на предмет неработоспособных виджетов и диплинков и принять соответствующие меры.

## Используемые библиотеки и фреймворки

*   `requests`: Используется для отправки HTTP-запросов к API WordPress и API Tripster.
*   `python-dotenv`: Используется для загрузки переменных окружения из файла `.env`.
*   `beautifulsoup4`: Используется для парсинга HTML-контента страниц WordPress.
*   `urllib.parse`: Используется для работы с URL.

## Запуск скриптов

В разделе "Быстрый старт" описан основной порядок запуска скриптов. Вот более подробное описание каждого скрипта и процесса их работы.

1.  **`wordpress_post_indexer.py`**:

    *   **Назначение:** Скрипт является первым шагом в процессе мониторинга. Он подключается к WordPress API вашего сайта, собирает список всех постов и извлекает из них необходимую информацию: ID постов, заголовки. Главная цель - подготовить данные для дальнейшей обработки и поиска виджетов и ссылок Tripster.
    *   **Действия:**
        *   Читает переменные окружения из файла `.env`, включая `BASE_URL`, `API_PATH`, `POSTS_PER_PAGE`.
        *   Запрашивает WordPress API (`/wp-json/wp/v2/posts`) постранично, получая список постов.
        *   Для каждого поста извлекает ID и заголовок.
        *   **Использует функцию `unescape_html` для декодирования HTML-сущностей в заголовках постов, чтобы правильно отображать специальные символы (например, кавычки, амперсанды). В случае ошибки при декодировании, возвращается исходный, необработанный текст.**
        *   Сохраняет полученные данные (ID и заголовки постов) в JSON файл `json/post_data.json`. Файл перезаписывается при каждом запуске скрипта.
    *   **Запуск:**
        ```bash
        python -m scripts.wordpress_post_indexer
        ```
    *   **Результат:** Создается или обновляется файл `json/post_data.json`, содержащий список постов WordPress с их ID и заголовками. Этот файл используется скриптом `tripster_link_processor.py` на следующем шаге.

2.  **`tripster_link_processor.py`**:

    *   **Назначение:** Скрипт является вторым и **последним** шагом. Он обрабатывает данные о постах WordPress, собранные на первом шаге, и **извлекает из контента каждого поста виджеты и партнерские ссылки Tripster**. Затем он проверяет работоспособность партнерских ссылок (для диплинков) и виджетов (через API) и сохраняет результаты.
    *   **Действия:**
        *   Читает переменные окружения из файла `.env`, включая `TRIPSTER_DOMAIN`.
        *   Читает данные о постах из JSON файла `json/post_data.json`, созданного скриптом `wordpress_post_indexer.py`.
        *   Для каждого поста:
            *   Запрашивает полную версию поста через WordPress API, получая HTML-контент.
            *   **Используя модуль `tripster_data_extractor.py`, извлекает из HTML-контента виджеты и партнерские ссылки Tripster. Для проверки статуса диплинков и виджетов используется функция `check_deeplink_status_api` из модуля `core/tripster_api_utils.py`.**
            *   Для каждой партнерской ссылки:
                *   Проверяет ее работоспособность, отправляя HEAD-запрос.
                *   Анализирует ответ, чтобы определить, ведет ли ссылка на страницу "Экскурсия не проводится". (В текущей версии, проверка работоспособности ссылок **не реализована**, только извлечение). **В будущих версиях планируется реализовать проверку валидности ссылок.**
            *   Сохраняет информацию о посте, найденных виджетах (с их статусом) и партнерских ссылках в JSON файл `json/tripster_links.json`. **Файл `json/tripster_links.json` перезаписывается при каждом запуске скрипта.**
    *   **Запуск:**
        ```bash
        python -m scripts.tripster_link_processor
        ```
    *   **Результат:** Обновляется файл `json/tripster_links.json`, который теперь содержит информацию о постах WordPress, найденных в них виджетах Tripster (с текущим статусом) и партнерских ссылках. **После выполнения скрипта необходимо вручную проанализировать файл `json/tripster_links.json` и проверить виджеты и ссылки на предмет неработоспособности. В случае обнаружения неработоспособных элементов, необходимо принять соответствующие меры (например, удалить их из поста или обновить ссылки).**

## Важные замечания по текущей версии скриптов:

*   Скрипт `tripster_link_processor.py` использует функцию `check_deeplink_status_api` из модуля `core/tripster_api_utils.py` для проверки статуса **диплинков и виджетов** Tripster через API.

*   **После выполнения скрипта `tripster_link_processor.py` необходимо вручную проанализировать файл `json/tripster_links.json` и проверить виджеты и ссылки на предмет неработоспособности. В случае обнаружения неработоспособных элементов, необходимо принять соответствующие меры (например, удалить их из поста или обновить ссылки).**

## Лицензия

Проект `Blink` распространяется под лицензией [MIT License](https://opensource.org/licenses/MIT).

## Автор

Дмитрий Лузин
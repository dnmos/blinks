# Blink: Мониторинг неработающих виджетов и ссылок Tripster

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## О проекте

**Blink** - это скрипт на Python, предназначенный для автоматического мониторинга виджетов и партнерских ссылок Tripster, размещенных на сайтах WordPress. Скрипт помогает выявлять неработающие виджеты и ссылки, которые могут возникать из-за удаления экскурсий на Tripster или других изменений. При обнаружении проблем, необходимо вручную проверять результаты и принимать меры для поддержания актуальности контента на сайте.

**Основные возможности:**

*   **Автоматическое обнаружение виджетов Tripster на страницах WordPress.**
*   **Проверка статуса виджетов Tripster.**
*   **Проверка работоспособности партнерских ссылок Tripster.**
*   **Автоматическое формирование отчета о неактивных виджетах и ссылках.**
*   **Автоматическая отправка уведомления в Telegram (реализована заглушка).**
*   **Ручная проверка и принятие мер на основе результатов работы скрипта.**

## Быстрый старт

Эти шаги помогут вам быстро запустить `Blink` для мониторинга ваших виджетов и ссылок Tripster.

**Предварительные шаги:**

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/dnmos/blinks.git
    cd blinks
    ```

2.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

3.  **Настройте `.env` файл:**
    Скопируйте файл `.env_example` в `.env` и заполните необходимые переменные окружения. Необходимые переменные для запуска:

    ```env
    PROJECT_ROOT = ""       # Корневая директория проекта (абсолютный путь).  Например: /home/user/blinks.  Используется для определения абсолютных путей к файлам и директориям внутри проекта.
    DOMAIN_TO_CHECK = ""    # Доменное имя вашего сайта WordPress (например: your-site.com).  Используется для формирования URL-адресов WordPress API.  **Должен указываться без `https://`.**
    API_PATH = "/wp-json/wp/v2/posts"  # Путь к API WordPress для получения постов.  Обычно не требует изменений.
    POSTS_PER_PAGE = 10      # Количество постов WordPress, получаемых за один запрос к API.  Влияет на количество запросов к API и скорость работы скрипта wordpress_post_indexer.py.
    TRIPSTER_DOMAIN = "tripster.ru" # Домен Tripster, используется для фильтрации и проверки ссылок, чтобы убедиться, что они ведут на сайт Tripster.
    JSON_DIR = "json"         # Директория для хранения JSON файлов с собранными данными.  Относительный путь от `PROJECT_ROOT`.
    POST_DATA_FILE = "post_data.json" # Имя файла для сохранения данных о постах WordPress (ID и заголовки).  Используется скриптом wordpress_post_indexer.py и tripster_link_processor.py.
    TRIPSTER_API_URL = ""    # URL для запросов к API Tripster
    USER_AGENT = ""          # User-Agent для HTTP-запросов

    # DB
    DB_HOST = ""          # Хост базы данных MySQL (например: localhost).
    DB_USER = ""          # Имя пользователя базы данных MySQL.
    DB_NAME = ""          # Имя базы данных MySQL.
    DB_PASSWORD = ""      # Пароль для доступа к базе данных MySQL.

    TELEGRAM_BOT_TOKEN = "" # Токен Telegram-бота, полученный от BotFather (необязательно, если не требуется отправка уведомлений в Telegram).
    TELEGRAM_CHAT_ID = ""    # ID чата, куда будут отправляться уведомления (необязательно, если не требуется отправка уведомлений в Telegram).
    ```
    Заполните значения напротив каждой переменной в файле `.env`. **Важно: Не удаляйте и не изменяйте названия переменных.**

**Запуск скриптов:**

```bash
python main.py
```

## Структура проекта

```
.
├── core
│   ├── __init__.py
│   ├── tripster_api_utils.py
│   ├── tripster_data_extractor.py
│   └── wp_api_utils.py
├── db
│   ├── db.py
│   ├── __init__.py
│   └── sql
│       └── db_create_tables.sql
├── .env
├── .gitignore
├── __init__.py
├── json
│   ├── post_data example.json
├── main.py
├── notifications
│   └── telegram_notifier.py
├── project_structure.txt
├── README.md
├── report
│   ├── report_generator.py
│   └── report_template.html
├── requirements.txt
├── scripts
│   ├── __init__.py
│   ├── tripster_link_processor.py
│   └── wordpress_post_indexer.py
└── tripster_report.pdf
```

```
tree -a -I "env|.git|.env_example" . > project_structure.txt
```

# Ключевые классы и функции:

*   **`core/wp_api_utils.py`**:
    *   `fetch_wordpress_posts(api_url, page=1)`: Получает список постов из WordPress API с учетом пагинации.
    *   `fetch_wordpress_post_by_id(api_url, post_id)`: Получает данные поста по его ID из API WordPress.
    *   `construct_json_file_path(filename)`: Строит полный путь к JSON-файлу, учитывая директорию JSON_DIR.
    *   `save_data_to_json_file(data, filename=None)`: Сохраняет данные в JSON-файл.
*   **`core/tripster_api_utils.py`**:
    *   `check_deeplink_status_api(deeplink_id)`: Проверяет статус диплинка через API Tripster. Результаты работы функции кешируются для повышения производительности.
*   **`core/tripster_data_extractor.py`**:
    *   `extract_tripster_widgets(html_content, tripster_domain="tripster.ru", max_retries=3, retry_delay=2)`: Извлекает виджеты Tripster из HTML-контента.
    *   `extract_deeplinks(html_content, tripster_domain="tripster.ru")`: Извлекает диплинки Tripster из HTML-контента, исключая ссылки внутри виджетов.
*   **`db/db.py`**:
    *   `connect()`: Устанавливает соединение с базой данных MySQL.
    *   `parse_sql(filename)`: Читает SQL-запросы из файла.
    *   `insert_or_update_data(data)`: Выполняет SQL-запрос для вставки или обновления данных в базу данных.
    *   `analyze_database()`: Анализирует базу данных для выявления неактивных виджетов и диплинков.
*   **`notifications/telegram_notifier.py`**:
    *   `send_telegram_notification(report_path)`: Отправляет уведомление в Telegram.
*   **`report/report_generator.py`**:
    *   `generate_report(inactive_items, output_filename="tripster_report.pdf")`: Генерирует PDF-отчет о неактивных виджетах и ссылках.
*   **`scripts/tripster_link_processor.py`**:
    *   `process_tripster_links()`: Извлекает и сохраняет виджеты и диплинки из постов WordPress.
*   **`scripts/wordpress_post_indexer.py`**:
    *   `process_wordpress_posts()`: Получает и обрабатывает посты из WordPress API, сохраняя их в JSON.

## Важные замечания по текущей версии скриптов:

*   Скрипт `tripster_link_processor.py` использует функцию `check_deeplink_status_api` из модуля `core/tripster_api_utils.py` для проверки статуса **диплинков и виджетов** Tripster через API. Результаты работы функции кешируются для повышения производительности.
*   Данные о виджетах и ссылках сохраняются в базе данных MySQL, используя функцию `insert_or_update_data` из `db/db.py`.
*   После выполнения скрипта `tripster_link_processor.py` скрипт `main.py` автоматически анализирует данные в базе данных и формирует отчет о неактивных элементах.
*   Скрипт `main.py` автоматически отправляет уведомление в Telegram с прикрепленным PDF-отчетом.

## Вклад в проект

Мы приветствуем вклад в развитие проекта `Blink`! Чтобы ваш вклад был максимально эффективным и соответствовал целям проекта, пожалуйста, ознакомьтесь со следующими рекомендациями.

### Входные данные и ожидаемые результаты

Каждый скрипт в проекте имеет определенные входные данные и создает определенные выходные данные.

*   **`wordpress_post_indexer.py`**:
    *   Входные данные:
        *   Переменные окружения: `DOMAIN_TO_CHECK`, `API_PATH`, `POSTS_PER_PAGE` (определены в файле `.env`).
        *   WordPress API доступный по адресу, сформированному из `DOMAIN_TO_CHECK` и `API_PATH`.
    *   Выходные данные:
        *   JSON файл `json/post_data.json`, содержащий список постов WordPress (ID и заголовки).
        *   Лог-сообщения в консоль и в файл (если настроено).
    *   Ожидаемый формат выходных данных:
        ```json
        [
            {
                "order": 1,
                "id": 123,
                "title": "Заголовок поста"
            },
            ...
        ]
        ```

*   **`tripster_link_processor.py`**:
    *   Входные данные:
        *   Переменные окружения: `TRIPSTER_DOMAIN`, `MAX_RETRIES`, `RETRY_DELAY`, `DB_HOST`, `DB_USER`, `DB_NAME`, `DB_PASSWORD` (определены в файле `.env`).
        *   JSON файл `json/post_data.json`, созданный скриптом `wordpress_post_indexer.py`.
        *   HTML-контент постов WordPress, полученный через WordPress API.
    *   Выходные данные:
        *   Данные о виджетах и ссылках Tripster, сохраненные в таблице `wptq_tripster_links` базы данных MySQL.
        *   Лог-сообщения в консоль и в файл (если настроено).
    *   Ожидаемый формат выходных данных:
        ```sql
        Таблица `wptq_tripster_links` содержит следующие поля:
            id INT AUTO_INCREMENT PRIMARY KEY,
            post_id VARCHAR(255) NOT NULL,
            post_title VARCHAR(255) NOT NULL,
            link_type ENUM('widget', 'deeplink') NOT NULL,
            exp_id VARCHAR(255) NULL,
            exp_title VARCHAR(255) NULL,
            exp_url VARCHAR(255) NULL,
            link_status ENUM('active', 'inactive') NOT NULL,
            inactivity_reason VARCHAR(255) NULL,
            is_unknown_type BOOLEAN NOT NULL DEFAULT FALSE,
            UNIQUE KEY `unique_link` (`post_id`, `link_type`, `exp_id`, `exp_url`)
        ```

### Стандарты кодирования

Для поддержания высокого качества кода и упрощения совместной работы, мы придерживаемся следующих стандартов кодирования:

*   **Соответствие PEP 8:** Код должен соответствовать стандарту PEP 8 для оформления кода на Python.
*   **Читаемость кода:** Код должен быть написан таким образом, чтобы его было легко читать и понимать. Используйте понятные имена переменных и функций, избегайте сложного и запутанного кода.
*   **Документирование кода:** Код должен быть хорошо документирован с использованием комментариев и docstrings. Каждый модуль, класс и функция должны иметь docstring, описывающий их назначение, аргументы и возвращаемые значения.
*   **Проверка стиля кода:** Используйте инструменты `flake8` и `pylint` для автоматической проверки соответствия кода стандартам кодирования.

### Потребность в документации

Мы считаем, что хорошо документированный код - это важная часть любого успешного проекта.

*   **Docstrings:** Каждый модуль, класс и функция должны иметь docstring, описывающий их назначение, аргументы и возвращаемые значения.
*   **Комментарии:** Используйте комментарии для объяснения сложных участков кода и для предоставления дополнительной информации.

### Поддержание структуры

Поддержание четкой и понятной структуры проекта - это важно для упрощения навигации и понимания кода.

*   **Следование структуре:** Размещайте файлы в соответствующих директориях (например, основные модули в `core`, скрипты в `scripts`).
*   **Согласованность:** Поддерживайте согласованность в именовании файлов, классов и функций.

### Фокус на читаемости кода

Читаемый код - это код, который легко понять и поддерживать.

*   **Именование:** Используйте понятные и описательные имена для переменных, функций и классов.
*   **Разбиение на функции:** Разбивайте сложные функции на более мелкие и простые.
*   **Избегайте сложных конструкций:** Старайтесь избегать слишком сложных и запутанных конструкций кода.

### Подробное описание условий

Для обеспечения правильной работы скриптов, необходимо соблюдать определенные условия.

*   **Доступ к API:** Убедитесь, что у вас есть доступ к API Tripster и WordPress и что вы соблюдаете условия использования API.
*   **Переменные окружения:** Убедитесь, что все необходимые переменные окружения определены в файле `.env` и имеют правильные значения.
*   **Зависимости:** Убедитесь, что все необходимые Python-библиотеки установлены.
*   **База данных MySQL:** Убедитесь, что у вас есть доступ к базе данных MySQL и что таблица `wptq_tripster_links` (или ее аналог) создана.

## План разработки

*   **Анализ данных в базе данных:** Автоматически анализировать данные в базе данных и отфильтровывать с помощью SQL запроса виджеты и ссылки с признаками неработоспособности и неактивности. **(Выполнено)**
*   **Отчет о неактивных виджетах и ссылках:** Автоматически составлять отчет о неработающих и неактивных виджетах и ссылках на основе анализа данных. В отчете указывать сколько вижетов и ссылок обнаружено, перечень неактивных виджетов и ссылок с указанием заголовка поста, порядкового номера и заголовка виджета, порядкового номера и анкора ссылки, а также причины неактивности виджетов и ссылок.  **(Выполнено, за исключением добавления порядковых номеров виджетам и ссылкам. Необходимо добавить эту функциональность в будущем).**
*   **Уведомление в Телеграм:** Автоматически отправлять краткое уведомление в телеграм бот `@broken_link_bot` об выполнении проверки виджетов и ссылок с прикрепленным PDF отчетом о неактивных виджетах и ссылках. В уведомлении указывать дату и время проверки, общий количественный результат и упоминание отчета. **(Выполнено, реализована заглушка из-за отсутствия доступа к Telegram API).**

## Лицензия

Проект `Blink` распространяется под лицензией [MIT License](https://opensource.org/licenses/MIT).

## Автор

Дмитрий Лузин